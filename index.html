<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Dibujos animados</title>
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&display=swap" rel="stylesheet">
  <style>
    body{
      margin:0;height:100vh;background:#000;color:#e9e9ee;font-family:sans-serif;
      display:flex;align-items:center;justify-content:center;
      flex-direction:column;
    }
    #container{display:flex;gap:20px;align-items:flex-start;flex-wrap:wrap;justify-content:center}
    canvas{
      background:#000;display:block;border-radius:12px;
      max-width:90vw;max-height:90vh;width:100%;height:auto;
    }
    #controls{display:flex;flex-direction:column;gap:15px;align-items:center}
    button{
      background:#ff4d6d;border:none;color:#fff;
      padding:16px 32px;   /* mÃ¡s padding (doble tamaÃ±o) */
      border-radius:10px;
      cursor:pointer;font-size:20px;  /* letra mÃ¡s grande */
      text-align:center;width:100%;
    }
    button:hover{background:#ff718a}
    #dedicatoria{
      margin-top:15px;font-size:36px;text-align:center;
      color:#ff99b3;font-family:'Dancing Script', cursive;
      text-shadow: 2px 2px 6px rgba(0,0,0,0.6);
    }
  </style>
<head>
<body>
<div id="container">
  <canvas id="cv"></canvas>
  <div id="controls">
    <button id="savePng">ðŸ–¼ Descargar PNG</button>
    <button onclick="loadDrawing('puntos.json')">ðŸŒ¹ Rosa</button>
    <button onclick="loadDrawing('eva.json')">âœ¨ Retrato</button>
    <button onclick="loadDrawing('espino.json')">ðŸ¦– Dino</button>
    <button id="playMusic">â–¶ Reproducir mÃºsica</button>
  </div>
</div>

<div id="dedicatoria">âœ¨ Para Eva, con todo mi cariÃ±o âœ¨</div>

<audio id="bgmusic" loop>
  <source src="cancion.mp3" type="audio/mpeg">
</audio>

<script>
let DELAY = 150;
const START_ANGLE = -90 * Math.PI/180;
const END_ANGLE   = 0;
const BG = "#000";
const scaleFactor = 1.2;  // âœ… ampliamos el dibujo un 20%

const cv = document.getElementById("cv");
const ctx = cv.getContext("2d");
const saveBtn = document.getElementById("savePng");
const music = document.getElementById("bgmusic");
const playBtn = document.getElementById("playMusic");

let regions=null, currentFile="", bgMask=[], bgColorHex=null;
let CANVAS_SIZE=800;

// -------- resize dinÃ¡mico --------
function resizeCanvas(){
  const size = Math.min(window.innerWidth*0.9, window.innerHeight*0.7);
  CANVAS_SIZE = Math.max(200, Math.floor(size));
  cv.width = CANVAS_SIZE;
  cv.height = CANVAS_SIZE;
}
window.addEventListener("resize", ()=>{ 
  resizeCanvas(); 
  if(regions) startAnim(); 
});
resizeCanvas();

// ---------- utilidades ----------
function toHex(c){ if(typeof c==="string") return c;
  return `#${c[0].toString(16).padStart(2,'0')}${c[1].toString(16).padStart(2,'0')}${c[2].toString(16).padStart(2,'0')}`;
}
function hexToRGB(hex){ if(hex.startsWith('#')) hex=hex.slice(1);
  if(hex.length===3) hex=hex.split('').map(c=>c+c).join('');
  return [parseInt(hex.slice(0,2),16), parseInt(hex.slice(2,4),16), parseInt(hex.slice(4,6),16)];
}
function luminance(hex){ const [r,g,b]=hexToRGB(hex); return 0.2126*r+0.7152*g+0.0722*b; }
function colorDist(aHex,bHex){ const [ar,ag,ab]=hexToRGB(aHex), [br,bg,bb]=hexToRGB(bHex);
  return Math.sqrt((ar-br)**2+(ag-bg)**2+(ab-bb)**2);
}
function bbox(regs){ let minx=1e9,miny=1e9,maxx=-1e9,maxy=-1e9;
  regs.forEach(r=>r.contour.forEach(([x,y])=>{if(x<minx)minx=x;if(y<miny)miny=y;if(x>maxx)maxx=x;if(y>maxy)maxy=y;}));
  return {minx,miny,maxx,maxy};
}
function areaPoly(c){ let a=0; for(let i=0;i<c.length;i++){const[x1,y1]=c[i],[x2,y2]=c[(i+1)%c.length];a+=x1*y2-x2*y1;} return Math.abs(a/2);}
function regionBBox(c){ let minx=1e9,miny=1e9,maxx=-1e9,maxy=-1e9; for(const[x,y] of c){if(x<minx)minx=x;if(y<miny)miny=y;if(x>maxx)maxx=x;if(y>maxy)maxy=y;} return{minx,miny,maxx,maxy};}
function touchesBorder(rb,gb,tol=1e-6){return Math.abs(rb.minx-gb.minx)<tol||Math.abs(rb.maxx-gb.maxx)<tol||Math.abs(rb.miny-gb.miny)<tol||Math.abs(rb.maxy-gb.maxy)<tol;}
function transformPts(pts,cx,cy,scale,ang){const ca=Math.cos(ang),sa=Math.sin(ang);return pts.map(([x,y])=>{const tx=(x-cx)*scale,ty=(cy-y)*scale;return[tx*ca-ty*sa,tx*sa+ty*ca];});}
function drawPoly(pts,fill){ctx.fillStyle=fill;ctx.beginPath();ctx.moveTo(pts[0][0]+CANVAS_SIZE/2,pts[0][1]+CANVAS_SIZE/2);for(let i=1;i<pts.length;i++)ctx.lineTo(pts[i][0]+CANVAS_SIZE/2,pts[i][1]+CANVAS_SIZE/2);ctx.closePath();ctx.fill();}
function normalize(data){const list=Array.isArray(data)?data:data.regions;return list.map(r=>({contour:r.contour||r.points,fill:toHex(r.fill||"#ff4d6d")})).filter(r=>r.contour&&r.contour.length>=3);}

// ---------- fondo ----------
const COLOR_TOL=40;
function detectBackgroundRegions(regs){
  const gb=bbox(regs);const areas=regs.map(r=>areaPoly(r.contour));const maxArea=Math.max(...areas);
  bgColorHex=toHex(regs[areas.indexOf(maxArea)].fill);
  return regs.map((r,i)=>{const rb=regionBBox(r.contour);const touch=touchesBorder(rb,gb,1e-6);
    const isBig=areas[i]>=maxArea*0.9;const isDark=luminance(toHex(r.fill))<40;
    return touch&&(isBig||isDark||colorDist(toHex(r.fill),bgColorHex)<COLOR_TOL);});
}

// ---------- animaciÃ³n ----------
function startAnim(){
  const {minx,miny,maxx,maxy}=bbox(regions);
  const margin=10;
  const scale=scaleFactor*Math.min(
    (CANVAS_SIZE-margin*2)/(maxx-minx),
    (CANVAS_SIZE-margin*2)/(maxy-miny)
  );
  const cx=(minx+maxx)/2,cy=(miny+maxy)/2;
  const start=performance.now();
  function frame(ts){
    ctx.fillStyle=BG;ctx.fillRect(0,0,CANVAS_SIZE,CANVAS_SIZE);
    const elapsed=ts-start,total=regions.length*DELAY,prog=Math.min(1,elapsed/total);
    let ang=0;if(currentFile!=="eva.json"&&currentFile!=="espino.json"){const s=prog*prog*(3-2*prog);ang=START_ANGLE+(END_ANGLE-START_ANGLE)*s;}
    const show=Math.min(regions.length,Math.floor(elapsed/DELAY)+1);
    for(let i=0;i<show;i++){const r=regions[i];const pts=transformPts(r.contour,cx,cy,scale,ang);
      let fill=r.fill;if((currentFile==="eva.json"||currentFile==="espino.json")&&bgMask[i])fill="#000";
      drawPoly(pts,fill);}
    requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
}

// ---------- UI ----------
saveBtn.onclick=()=>{const link=document.createElement("a");link.download=(currentFile||"dibujo")+".png";link.href=cv.toDataURL("image/png");link.click();};
function loadDrawing(file){
  currentFile=file;if(file==="puntos.json")DELAY=50;else if(file==="eva.json")DELAY=2;else if(file==="espino.json")DELAY=1;else DELAY=280;
  fetch(file).then(r=>r.json()).then(data=>{regions=normalize(data);bgMask=detectBackgroundRegions(regions);startAnim();});
}
playBtn.onclick=()=>{music.play();playBtn.textContent="ðŸŽµ Reproduciendo...";playBtn.disabled=true;};
loadDrawing("puntos.json");
</script>
</body>
</html>



